<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>シシリアンディフェンス インタラクティブチェス盤</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
      body {
        font-family: "Noto Sans JP", sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1,
      h2,
      h3,
      h4 {
        color: #2c3e50;
        margin-top: 1.5em;
      }
      h1 {
        text-align: center;
        font-size: 2.5em;
        margin-bottom: 1em;
        border-bottom: 2px solid #4a90e2;
        padding-bottom: 0.5em;
      }
      .container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }
      .board-container {
        flex: 1;
        min-width: 400px;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .info-container {
        flex: 1;
        min-width: 400px;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .variation-selector {
        margin-bottom: 20px;
      }
      .moves-container {
        height: 250px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
      }
      .move {
        display: inline-block;
        margin: 5px;
        padding: 5px 10px;
        background-color: #e7f4ff;
        border-radius: 4px;
        cursor: pointer;
      }
      .move:hover {
        background-color: #d0e8ff;
      }
      .move.current {
        background-color: #4a90e2;
        color: white;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 8px 16px;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #357abd;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .explanation {
        margin-top: 20px;
        padding: 15px;
        background-color: #f0f7ff;
        border-left: 4px solid #4a90e2;
      }
      .fen-code {
        font-family: monospace;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        margin-bottom: 20px;
      }
      .mode-switch {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }
      .pgn-display {
        max-height: 100px;
        overflow-y: auto;
        font-family: monospace;
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      #history {
        max-height: 250px;
        overflow-y: auto;
        margin-top: 10px;
      }
      .history-move {
        display: inline-block;
        margin: 2px;
        padding: 3px 8px;
        background-color: #e7f4ff;
        border-radius: 4px;
      }
      .tab-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 10px;
      }
      .tab-button {
        padding: 8px 16px;
        background-color: #e7e7e7;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .tab-button.active {
        background-color: #4a90e2;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .input-move-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
        background-color: #f8f8f8;
        padding: 15px;
        border-radius: 8px;
      }
      .input-move-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .input-move-white {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 5px 10px;
        flex: 1;
        border-radius: 4px;
      }
      .input-move-black {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        padding: 5px 10px;
        flex: 1;
        border-radius: 4px;
      }
      .move-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: monospace;
      }
      .move-button {
        padding: 8px 12px;
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .move-error {
        color: #e74c3c;
        font-size: 0.9em;
        margin-top: 5px;
        display: none;
      }
      .notation-help {
        font-size: 0.85em;
        margin-top: 10px;
        color: #666;
      }
      .white-indicator,
      .black-indicator {
        width: 12px;
        height: 12px;
        display: inline-block;
        border-radius: 50%;
        margin-right: 5px;
      }
      .white-indicator {
        background-color: white;
        border: 1px solid #ddd;
      }
      .black-indicator {
        background-color: #333;
      }
      .current-turn {
        font-weight: bold;
        color: #4a90e2;
        margin-left: 5px;
      }
      .not-turn {
        color: #999;
      }
    </style>
  </head>
  <body>
    <h1>シシリアンディフェンス インタラクティブチェス盤</h1>

    <div class="container">
      <div class="board-container">
        <div class="variation-selector">
          <label for="variation">バリエーションを選択:</label>
          <select id="variation">
            <option value="basic">シシリアンディフェンス 基本形</option>
            <option value="najdorf">ナイドルフバリエーション</option>
            <option value="dragon">ドラゴンバリエーション</option>
            <option value="scheveningen">シェベニンゲンバリエーション</option>
            <option value="classical">クラシカルバリエーション</option>
            <option value="accelerated_dragon">
              アクセレレイテッドドラゴン
            </option>
            <option value="kan">カン・バリエーション</option>
            <option value="four_knights">フォー・ナイツ・バリエーション</option>
            <option value="closed">クローズドシシリアン</option>
            <option value="grand_prix">グランプリアタック</option>
            <option value="moscow">モスクワバリエーション</option>
            <option value="rossolimo">ロゾリモアタック</option>
          </select>
        </div>

        <div class="mode-switch">
          <button id="studyModeBtn" class="tab-button active">
            学習モード
          </button>
          <button id="freeModeBtn" class="tab-button">自由に駒を動かす</button>
        </div>

        <div id="board" style="width: 400px"></div>

        <div id="studyModeControls" class="tab-content active">
          <div class="controls">
            <button id="startBtn">最初へ</button>
            <button id="prevBtn">前へ</button>
            <button id="nextBtn">次へ</button>
            <button id="endBtn">最後へ</button>
          </div>
        </div>

        <div id="freeModeControls" class="tab-content">
          <div class="controls">
            <button id="resetBtn">盤面をリセット</button>
            <button id="flipBtn">盤面を反転</button>
            <button id="startPositionBtn">初期配置に戻す</button>
            <button id="clearBoardBtn">全ての駒を取り除く</button>
          </div>

          <div class="input-move-container">
            <h3>チェス記法で駒を動かす</h3>
            <div class="input-move-row">
              <div class="input-move-white">
                <label>
                  <span class="white-indicator"></span> 白の手:
                  <span id="white-turn-indicator" class="current-turn"
                    >手番</span
                  >
                </label>
                <input
                  type="text"
                  id="white-move-input"
                  class="move-input"
                  placeholder="例: e2e4, e4, Nf3"
                />
                <div id="white-move-error" class="move-error">
                  無効な手です。再入力してください。
                </div>
              </div>
              <button id="white-move-btn" class="move-button">指す</button>
            </div>

            <div class="input-move-row">
              <div class="input-move-black">
                <label>
                  <span class="black-indicator"></span> 黒の手:
                  <span id="black-turn-indicator" class="not-turn">待機中</span>
                </label>
                <input
                  type="text"
                  id="black-move-input"
                  class="move-input"
                  placeholder="例: e7e5, c5, Nf6"
                />
                <div id="black-move-error" class="move-error">
                  無効な手です。再入力してください。
                </div>
              </div>
              <button id="black-move-btn" class="move-button">指す</button>
            </div>

            <div class="notation-help">
              <p><strong>使用できる記法:</strong></p>
              <ul>
                <li>
                  <strong>標準代数記法 (SAN):</strong> e4, Nf3, Bxe5, O-O
                  (キングサイドキャスリング)
                </li>
                <li><strong>長い代数記法:</strong> e2e4, g1f3, f1c4</li>
                <li><strong>UCI記法:</strong> e2e4, g1f3</li>
              </ul>
            </div>
          </div>

          <div class="pgn-display" id="pgn-display"></div>
          <div id="history"></div>
        </div>
      </div>
      <div class="info-container">
        <div class="tab-buttons">
          <button id="infoTabBtn" class="tab-button active">
            バリエーション情報
          </button>
          <button id="fenTabBtn" class="tab-button">技術情報</button>
        </div>

        <div id="infoTab" class="tab-content active">
          <h3 id="variation-title">シシリアンディフェンス 基本形</h3>
          <div class="moves-container" id="moves"></div>
          <div class="explanation" id="explanation">
            <p>
              シシリアンディフェンスは、1.e4に対して1...c5と応じる黒のオープニングです。白の中央ポーンに対抗し、中央のコントロールを争います。
            </p>
            <p>
              クイーンサイドのスペースが広がり、駒展開や攻撃に有利に働きます。多くのバリエーションがあり、自分のプレイスタイルに合わせて選ぶことができます。
            </p>
          </div>
        </div>

        <div id="fenTab" class="tab-content">
          <h3>FEN表記</h3>
          <div class="fen-code" id="current-fen">
            rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1
          </div>

          <h3>ヘルプ</h3>
          <p>
            <strong>学習モード</strong>: 各バリエーションの手順を確認できます。
          </p>
          <p>
            <strong>自由に駒を動かす</strong>:
            駒をドラッグして好きな位置に配置できます。有効な手だけが許可されます。
          </p>
          <p>
            <strong>チェス記法で入力</strong>:
            入力フォームにチェス記法で手を入力して駒を動かせます。自動的に現在の手番（白または黒）が表示されます。
          </p>
          <p>
            盤面をリセットするには「盤面をリセット」ボタンを押してください。
          </p>
        </div>
      </div>
    </div>

    <script>
      // バリエーションのPGNデータ
      const variations = {
        basic: {
          title: "シシリアンディフェンス 基本形",
          pgn: "1. e4 c5",
          explanation:
            "シシリアンディフェンスは、1.e4に対して1...c5と応じる黒のオープニングです。白の中央ポーンに対抗し、中央のコントロールを争います。クイーンサイドのスペースが広がり、駒展開や攻撃に有利に働きます。",
        },
        najdorf: {
          title: "ナイドルフバリエーション",
          pgn: "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6",
          explanation:
            "ナイドルフバリエーションは、5...a6と指す形で、カスパロフやフィッシャーも好んで使用したバリエーションです。a6と突きだす手の意図は、b5の地点に利かせることで白のNb5やBb5を予め潰しておくと共に、将来的には自分でb5~Bb7とフィアンケットを組む準備をします。",
        },
        dragon: {
          title: "ドラゴンバリエーション",
          pgn: "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 g6",
          explanation:
            "ドラゴンバリエーションは、5...g6と指し、ビショップをg7にフィアンケットする形です。このビショップが長い対角線上で強力な働きをするため、「ドラゴン」と呼ばれています。攻撃的なバリエーションとして知られています。",
        },
        scheveningen: {
          title: "シェベニンゲンバリエーション",
          pgn: "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 e6",
          explanation:
            "シェベニンゲンバリエーションは、5...e6と指す形です。堅実な構えで、キングの安全を確保しながらカウンター攻撃の準備をします。柔軟性が高く、様々な状況に対応できるバリエーションです。",
        },
        classical: {
          title: "クラシカルバリエーション",
          pgn: "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 Nc6",
          explanation:
            "クラシカルバリエーションは、5...Nc6と指す形です。ナイトを積極的に中央に展開し、e5の地点を支配します。駒の展開が自然で、初心者にも扱いやすいバリエーションです。",
        },
        accelerated_dragon: {
          title: "アクセレレイテッドドラゴン",
          pgn: "1. e4 c5 2. Nf3 Nc6 3. d4 cxd4 4. Nxd4 g6",
          explanation:
            "アクセレレイテッドドラゴンは、4...g6と早めにビショップをフィアンケットする形です。通常のドラゴンバリエーションよりも早くg6と指すことで、白のマレーシー・バインド（c4, e4, d4のポーン配置）を避けることができます。",
        },
        kan: {
          title: "カン・バリエーション",
          pgn: "1. e4 c5 2. Nf3 e6 3. d4 cxd4 4. Nxd4 a6",
          explanation:
            "カン・バリエーションは、e6とa6を組み合わせた形です。シェベニンゲンバリエーションとナイドルフバリエーションの要素を取り入れた柔軟な構えで、様々な展開に対応できます。",
        },
        four_knights: {
          title: "フォー・ナイツ・バリエーション",
          pgn: "1. e4 c5 2. Nf3 e6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 Nc6",
          explanation:
            "フォー・ナイツ・バリエーションは、両者が2つのナイトを展開する形です。バランスの取れた構えで、中央のコントロールを争います。",
        },
        closed: {
          title: "クローズドシシリアン",
          pgn: "1. e4 c5 2. c3",
          explanation:
            "クローズドシシリアンは、白が2.c3と指す形です。d4の突破を準備しながら、黒のカウンタープレイを制限します。穏やかな展開を好む白向けのバリエーションです。",
        },
        grand_prix: {
          title: "グランプリアタック",
          pgn: "1. e4 c5 2. f4",
          explanation:
            "グランプリアタックは、白が2.f4と指す攻撃的なバリエーションです。キングサイドからの攻撃を準備しますが、中央のコントロールが弱くなるリスクもあります。",
        },
        moscow: {
          title: "モスクワバリエーション",
          pgn: "1. e4 c5 2. Nf3 d6 3. Bb5+",
          explanation:
            "モスクワバリエーションは、白が3.Bb5+と指す形です。黒のナイトの展開を妨げ、d5の地点のコントロールを争います。",
        },
        rossolimo: {
          title: "ロゾリモアタック",
          pgn: "1. e4 c5 2. Nf3 Nc6 3. Bb5",
          explanation:
            "ロゾリモアタックは、白が3.Bb5と指す形です。c6のナイトを攻撃し、黒の駒の展開を妨げます。オープンシシリアンを避けたい白向けのバリエーションです。",
        },
      };

      // チェス盤とゲームの初期化
      let board = null;
      let game = new Chess();
      let currentMoveIndex = 0;
      let moveHistory = [];
      let isStudyMode = true;
      let boardConfig = {
        pieceTheme:
          "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
        position: "start",
        draggable: false,
      };

      // DOMが読み込まれた後に実行
      $(document).ready(function () {
        // チェス盤の初期化
        board = Chessboard("board", boardConfig);

        // バリエーション選択時の処理
        $("#variation").change(function () {
          if (isStudyMode) {
            loadVariation($(this).val());
          }
        });

        // コントロールボタンの処理
        $("#startBtn").click(function () {
          goToMove(0);
        });

        $("#prevBtn").click(function () {
          if (currentMoveIndex > 0) {
            goToMove(currentMoveIndex - 1);
          }
        });

        $("#nextBtn").click(function () {
          if (currentMoveIndex < moveHistory.length - 1) {
            goToMove(currentMoveIndex + 1);
          }
        });

        $("#endBtn").click(function () {
          goToMove(moveHistory.length - 1);
        });

        // 手をクリックしたときの処理
        $(document).on("click", ".move", function () {
          const moveIndex = $(this).data("index");
          goToMove(moveIndex);
        });

        // 自由モードのボタン処理
        $("#resetBtn").click(function () {
          resetFreeMode();
        });

        $("#flipBtn").click(function () {
          board.flip();
        });

        $("#startPositionBtn").click(function () {
          game = new Chess();
          board.position("start");
          updateBoard();
          updateTurnIndicators();
        });

        $("#clearBoardBtn").click(function () {
          game = new Chess("8/8/8/8/8/8/8/8 w - - 0 1");
          board.position("8/8/8/8/8/8/8/8");
          updateBoard();
          updateTurnIndicators();
        });

        // モード切り替えボタンの処理
        $("#studyModeBtn").click(function () {
          switchToStudyMode();
        });

        $("#freeModeBtn").click(function () {
          switchToFreeMode();
        });

        // タブ切り替えボタンの処理
        $("#infoTabBtn").click(function () {
          $(".tab-button").removeClass("active");
          $(this).addClass("active");
          $(".tab-content").removeClass("active");
          $("#infoTab").addClass("active");
        });

        $("#fenTabBtn").click(function () {
          $(".tab-button").removeClass("active");
          $(this).addClass("active");
          $(".tab-content").removeClass("active");
          $("#fenTab").addClass("active");
        });

        // 記法入力による駒の移動処理
        $("#white-move-btn").click(function () {
          makeMove("white");
        });

        $("#black-move-btn").click(function () {
          makeMove("black");
        });

        // Enterキーで駒を動かす
        $("#white-move-input").keypress(function (e) {
          if (e.which === 13) {
            makeMove("white");
          }
        });

        $("#black-move-input").keypress(function (e) {
          if (e.which === 13) {
            makeMove("black");
          }
        });

        // 初期バリエーションの読み込み
        loadVariation("basic");
      });

      // 記法で駒を動かす関数
      function makeMove(color) {
        // 現在の手番を確認
        const currentTurn = game.turn();
        if (
          (color === "white" && currentTurn !== "w") ||
          (color === "black" && currentTurn !== "b")
        ) {
          showMoveError(color, "現在の手番ではありません");
          return;
        }

        const moveInput = $(`#${color}-move-input`).val().trim();
        if (!moveInput) {
          return;
        }

        try {
          // チェス記法をいくつか試す
          let move = null;

          // 1. 標準代数記法 (SAN) を試す - e4, Nf3など
          try {
            move = game.move(moveInput);
          } catch (e) {
            // 失敗してもエラーを表示しない
          }

          // 2. 長い代数記法 - e2e4, g1f3など
          if (!move && moveInput.length >= 4) {
            const from = moveInput.substring(0, 2);
            const to = moveInput.substring(2, 4);

            // プロモーションの処理
            let promotion = undefined;
            if (moveInput.length > 4) {
              const promotionPiece = moveInput.substring(4, 5).toLowerCase();
              if (["q", "r", "b", "n"].includes(promotionPiece)) {
                promotion = promotionPiece;
              }
            }

            try {
              move = game.move({
                from: from,
                to: to,
                promotion: promotion,
              });
            } catch (e) {
              // 失敗してもエラーを表示しない
            }
          }

          if (move) {
            // 駒が動かせた場合
            $(`#${color}-move-input`).val("");
            $(`#${color}-move-error`).hide();

            // 盤面を更新
            board.position(game.fen());
            updateBoard();
            updateTurnIndicators();
          } else {
            // 無効な手の場合
            showMoveError(color, "無効な手です。再入力してください。");
          }
        } catch (error) {
          showMoveError(color, "無効な手です。再入力してください。");
        }
      }

      // エラーメッセージを表示
      function showMoveError(color, message) {
        $(`#${color}-move-error`).text(message).show();
        setTimeout(() => {
          $(`#${color}-move-error`).fadeOut();
        }, 3000);
      }

      // 手番インジケータを更新
      function updateTurnIndicators() {
        if (game.turn() === "w") {
          $("#white-turn-indicator")
            .text("手番")
            .removeClass("not-turn")
            .addClass("current-turn");
          $("#black-turn-indicator")
            .text("待機中")
            .removeClass("current-turn")
            .addClass("not-turn");
        } else {
          $("#white-turn-indicator")
            .text("待機中")
            .removeClass("current-turn")
            .addClass("not-turn");
          $("#black-turn-indicator")
            .text("手番")
            .removeClass("not-turn")
            .addClass("current-turn");
        }
      }

      // 学習モードに切り替える
      function switchToStudyMode() {
        isStudyMode = true;
        $(".tab-button").removeClass("active");
        $("#studyModeBtn").addClass("active");
        $(".tab-content").removeClass("active");
        $("#studyModeControls").addClass("active");

        // チェス盤の設定を更新
        board = Chessboard("board", {
          pieceTheme:
            "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
          position: moveHistory[currentMoveIndex] || "start",
          draggable: false,
        });

        loadVariation($("#variation").val());
      }

      // 自由モードに切り替える
      function switchToFreeMode() {
        isStudyMode = false;
        $(".tab-button").removeClass("active");
        $("#freeModeBtn").addClass("active");
        $(".tab-content").removeClass("active");
        $("#freeModeControls").addClass("active");

        resetFreeMode();
      }

      // 自由モードをリセット
      function resetFreeMode() {
        game = new Chess();

        // チェス盤の設定を更新（ドラッグ可能に）
        board = Chessboard("board", {
          draggable: true,
          pieceTheme:
            "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
          position: "start",
          onDragStart: onDragStart,
          onDrop: onDrop,
          onSnapEnd: onSnapEnd,
        });

        updateBoard();
        updateTurnIndicators();
      }

      // ドラッグ開始時のチェック
      function onDragStart(source, piece, position, orientation) {
        // 動かす駒が現在の手番のものかチェック
        if (game.game_over()) return false;

        // 白の駒は'w'で始まり、黒の駒は'b'で始まる
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }

        return true;
      }

      // 駒をドロップしたときの処理
      function onDrop(source, target) {
        // 有効な手かチェック
        const move = game.move({
          from: source,
          to: target,
          promotion: "q", // クイーンに昇格（必要な場合）
        });

        // 無効な手の場合は元に戻す
        if (move === null) return "snapback";

        updateBoard();
        updateTurnIndicators();
      }

      // 駒がスナップした後の処理
      function onSnapEnd() {
        board.position(game.fen());
      }

      // 盤面の状態を更新
      function updateBoard() {
        // FEN表記を更新
        $("#current-fen").text(game.fen());

        // PGN表記を更新
        $("#pgn-display").text(game.pgn());

        // 指し手の履歴を更新
        updateHistory();
      }

      // 指し手の履歴を更新
      function updateHistory() {
        const history = game.history({ verbose: true });
        let html = "";

        for (let i = 0; i < history.length; i++) {
          const move = history[i];
          if (i % 2 === 0) {
            html += `<span class="history-move">${Math.floor(i / 2) + 1}.${
              move.san
            }</span>`;
          } else {
            html += `<span class="history-move">${move.san}</span>`;
          }
        }

        $("#history").html(html);
      }

      // バリエーションを読み込む関数
      function loadVariation(variationKey) {
        const variation = variations[variationKey];

        // タイトルと説明を更新
        $("#variation-title").text(variation.title);
        $("#explanation").html(`<p>${variation.explanation}</p>`);

        // PGNを解析してゲームを設定
        game = new Chess();
        const moves = variation.pgn.split(" ");
        moveHistory = ["start"];

        let moveStr = "";
        for (let i = 0; i < moves.length; i++) {
          const move = moves[i];
          if (move.match(/^\d+\./)) {
            moveStr += " " + move;
          } else {
            moveStr += " " + move;
            if (i < moves.length - 1 && !moves[i + 1].match(/^\d+\./)) {
              game.move(move);
              moveHistory.push(game.fen());
            } else {
              game.move(move);
              moveHistory.push(game.fen());
            }
          }
        }

        // 手順表示を更新
        updateMoves(moveStr);

        // 初期位置に戻す
        goToMove(0);
      }

      // 指定した手に移動する関数
      function goToMove(moveIndex) {
        currentMoveIndex = moveIndex;
        board.position(moveHistory[moveIndex]);

        // 現在の手をハイライト
        $(".move").removeClass("current");
        $(`.move[data-index="${moveIndex}"]`).addClass("current");

        // FEN表示を更新
        $("#current-fen").text(moveHistory[moveIndex]);

        // ボタンの有効/無効を更新
        $("#prevBtn, #startBtn").prop("disabled", moveIndex === 0);
        $("#nextBtn, #endBtn").prop(
          "disabled",
          moveIndex === moveHistory.length - 1
        );
      }

      // 手順表示を更新する関数
      function updateMoves(moveStr) {
        const $moves = $("#moves");
        $moves.empty();

        const moves = moveStr.trim().split(" ");
        let html = "";

        for (let i = 0; i < moveHistory.length; i++) {
          if (i === 0) {
            html += `<span class="move" data-index="0">開始</span>`;
          } else {
            const moveIndex = i - 1;
            const moveText = moves[moveIndex];
            html += `<span class="move" data-index="${i}">${moveText}</span>`;
          }
        }

        $moves.html(html);
      }
    </script>
  </body>
</html>
